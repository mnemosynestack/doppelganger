<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/icon.png" sizes="256x256" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doppelganger - Browser Automation for Everyone</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Geologica:wght@100..900&family=JetBrains+Mono:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script>
        (function () {
            const formId = 'gDG42l';
            const popupOptions = {
                emoji: { text: 'ðŸ‘‹', animation: 'wave' },
                formEventsForwarding: true,
                showOnce: true,
                autoClose: 3000,
                doNotShowAfterSubmit: true
            };
            const editorDelay = 5 * 60 * 1000;
            const weekMs = 7 * 24 * 60 * 60 * 1000;
            const lastShownKey = 'doppelganger.tally.lastShown';
            const submittedKey = 'doppelganger.tally.submitted';

            const ensureTallyReady = (callback) => {
                if (window.Tally) {
                    callback();
                    return;
                }
                const intervalId = window.setInterval(() => {
                    if (window.Tally) {
                        window.clearInterval(intervalId);
                        callback();
                    }
                }, 200);
            };

            const getLastShown = () => {
                const value = localStorage.getItem(lastShownKey);
                const parsed = Number(value);
                return Number.isFinite(parsed) ? parsed : 0;
            };

            const markShown = () => {
                localStorage.setItem(lastShownKey, String(Date.now()));
            };

            const hasSubmitted = () => localStorage.getItem(submittedKey) === 'true';

            let hasOpened = false;
            let timerId;
            let timerStarted = false;

            const clearTimer = () => {
                if (timerId) {
                    clearTimeout(timerId);
                    timerId = undefined;
                }
            };

            const openPopup = () => {
                if (hasOpened || hasSubmitted()) return;
                hasOpened = true;
                clearTimer();
                markShown();
                ensureTallyReady(() => {
                    if (window.Tally) {
                        window.Tally.openPopup(formId, popupOptions);
                    }
                });
            };

            const startEditorTimer = () => {
                if (hasOpened || timerStarted || hasSubmitted()) return;
                timerStarted = true;
                const shownAt = getLastShown();
                if (shownAt && Date.now() - shownAt < weekMs) {
                    return;
                }
                timerId = window.setTimeout(openPopup, editorDelay);
            };

            const onSubmission = (event) => {
                if (typeof event.data !== 'string' || !event.data.includes('Tally.FormSubmitted')) {
                    return;
                }
                localStorage.setItem(submittedKey, 'true');
                hasOpened = true;
                clearTimer();
            };

            const onLocationChange = () => {
                if (hasOpened) return;
                const path = window.location.pathname || '';
                if (path.startsWith('/tasks')) {
                    startEditorTimer();
                }
            };

            const wrapHistory = (method) => {
                const original = window.history[method];
                return function () {
                    const result = original.apply(this, arguments);
                    onLocationChange();
                    return result;
                };
            };

            if (window.history && window.history.pushState && window.history.replaceState) {
                window.history.pushState = wrapHistory('pushState');
                window.history.replaceState = wrapHistory('replaceState');
            }

            window.addEventListener('popstate', onLocationChange);
            window.addEventListener('message', onSubmission);
            onLocationChange();
        })();
    </script>

    <script async src="https://tally.so/widgets/embed.js"></script>
</head>

<body class="bg-[#020202] text-gray-100 font-sans h-full overflow-hidden selection:bg-white selection:text-black">
    <div id="root" class="h-full"></div>
    <script type="module" src="/src/main.tsx"></script>
</body>

</html>
