<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="/icon.png" sizes="256x256" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doppelganger - Browser Automation for Everyone</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script>
        (function () {
            const formId = 'gDG42l';
            const popupOptions = {
                emoji: { text: 'ðŸ‘‹', animation: 'wave' },
                formEventsForwarding: true,
                showOnce: true,
                autoClose: 3000,
                doNotShowAfterSubmit: true
            };
            const editorDelay = 300000;

            const ensureTallyReady = (callback) => {
                if (window.Tally) {
                    callback();
                    return;
                }
                const intervalId = window.setInterval(() => {
                    if (window.Tally) {
                        window.clearInterval(intervalId);
                        callback();
                    }
                }, 200);
            };

            let hasOpened = false;
            let timerId;
            const openPopup = () => {
                if (hasOpened) return;
                hasOpened = true;
                ensureTallyReady(() => {
                    if (window.Tally) {
                        window.Tally.openPopup(formId, popupOptions);
                    }
                });
            };

            const cancelTimer = () => {
                if (timerId) {
                    clearTimeout(timerId);
                    timerId = undefined;
                }
            };

            const startEditorTimer = () => {
                if (hasOpened || timerId) return;
                timerId = window.setTimeout(openPopup, editorDelay);
            };

            const onLocationChange = () => {
                if (hasOpened) {
                    cancelTimer();
                    return;
                }
                const path = window.location.pathname || '';
                if (path.startsWith('/tasks')) {
                    startEditorTimer();
                } else {
                    cancelTimer();
                }
            };

            const wrapHistory = (method) => {
                const original = window.history[method];
                return function () {
                    const result = original.apply(this, arguments);
                    onLocationChange();
                    return result;
                };
            };

            if (window.history && window.history.pushState && window.history.replaceState) {
                window.history.pushState = wrapHistory('pushState');
                window.history.replaceState = wrapHistory('replaceState');
            }

            window.addEventListener('popstate', onLocationChange);
            onLocationChange();
        })();
    </script>

    <script async src="https://tally.so/widgets/embed.js"></script>
</head>

<body class="bg-[#020202] text-gray-100 font-sans h-full overflow-hidden selection:bg-white selection:text-black">
    <div id="root" class="h-full"></div>
    <script type="module" src="/src/main.tsx"></script>
</body>

</html>
