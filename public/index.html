<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mnemosyne | Doppelgänger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#020202',
                        panel: 'rgba(10, 10, 10, 0.85)',
                        border: 'rgba(255, 255, 255, 0.08)',
                        accent: '#ffffff',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass {
                background: rgba(10, 10, 10, 0.85);
                backdrop-filter: blur(64px);
                -webkit-backdrop-filter: blur(64px);
                border-right: 1px solid rgba(255, 255, 255, 0.08);
            }
            .glass-card {
                background: rgba(255, 255, 255, 0.015);
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
                border: 1px solid rgba(255, 255, 255, 0.08);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .glass-card:hover {
                background: rgba(255, 255, 255, 0.04);
                border-color: rgba(255, 255, 255, 0.15);
            }
            .shine-effect {
                position: relative;
                overflow: hidden;
            }
            .shine-effect::after {
                content: '';
                position: absolute;
                top: -50%;
                left: -100%;
                width: 33.333333%;
                height: 200%;
                background: rgba(255, 255, 255, 0.2);
                transform: rotate(25deg);
                pointer-events: none;
                transition: none;
            }
            .shine-effect:hover::after {
                left: 150%;
                transition: left 0.7s ease-in-out;
            }
            .custom-scrollbar::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            .custom-scrollbar::-webkit-scrollbar-track {
                background: transparent;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 9999px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: rgba(255, 255, 255, 0.2);
            }
        }
    </style>
</head>

<body class="bg-bg text-gray-100 font-sans h-full overflow-hidden selection:bg-white selection:text-black">
    <div class="flex h-full">
        <!-- Sidebar / Control Panel -->
        <aside class="w-[420px] flex flex-col glass z-20 shadow-2xl overflow-hidden shrink-0">
            <!-- Header -->
            <div class="p-8 pb-4">
                <div class="mb-8 select-none">
                    <h1 class="text-xl font-bold tracking-tight text-white uppercase flex items-center gap-2">
                        <div class="w-8 h-8 overflow-hidden flex items-center justify-center -ml-1">
                            <img src="icon.png" class="w-12 max-w-none scale-[1.2] brightness-[5]" alt="">
                        </div>
                        <span>Doppelgänger</span>
                    </h1>
                    <span class="text-[7px] font-bold tracking-[0.4em] text-blue-500/80 mt-1 ml-10 uppercase">Beta
                        Stable</span>
                </div>

                <!-- Mission Modes -->
                <div class="bg-white/5 p-1 rounded-xl flex gap-1 border border-white/5 mb-6">
                    <button id="tab-scrape" onclick="setMode('scrape', this)"
                        class="mode-tab flex-1 py-2 text-[10px] font-bold tracking-widest uppercase rounded-lg transition-all duration-200 bg-white text-black shadow-lg">Scraper</button>
                    <button id="tab-agent" onclick="setMode('agent', this)"
                        class="mode-tab flex-1 py-2 text-[10px] font-bold tracking-widest uppercase rounded-lg transition-all duration-200 text-gray-400 hover:text-white">Agent</button>
                    <button id="tab-headful" onclick="setMode('headful', this)"
                        class="mode-tab flex-1 py-2 text-[10px] font-bold tracking-widest uppercase rounded-lg transition-all duration-200 text-gray-400 hover:text-white">Headful</button>
                </div>

                <!-- View Toggle -->
                <div class="flex gap-6 mb-4 border-b border-white/10">
                    <button id="btn-visual" onclick="setView('visual')"
                        class="pb-2 text-[10px] font-bold tracking-[0.2em] border-b-2 border-white text-white uppercase transition-all flex items-center gap-2">Visual
                        Editor <span
                            class="px-1 py-0.5 rounded bg-blue-500/10 text-[7px] text-blue-400 border border-blue-500/20">BETA</span></button>
                    <button id="btn-json" onclick="setView('json')"
                        class="pb-2 text-[10px] font-bold tracking-[0.2em] border-b-2 border-transparent text-gray-500 hover:text-gray-300 uppercase transition-all">JSON
                        RAW</button>
                </div>
            </div>

            <!-- Form Body -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-8 pt-4 space-y-8 min-h-0">
                <div id="visual-editor" class="space-y-6">
                    <!-- URL Block -->
                    <div class="space-y-2">
                        <label class="text-[9px] font-bold text-gray-400 uppercase tracking-[0.2em]">Target URL</label>
                        <input type="text" id="v-url" oninput="syncFromVisual()" placeholder="https://..."
                            class="w-full bg-white/[0.05] border border-white/10 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-white/30 focus:bg-white/[0.08] transition-all placeholder:text-gray-500 text-white">
                    </div>

                    <!-- Scraper Fields -->
                    <div id="v-scraper-fields" class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-[9px] font-bold text-gray-400 uppercase tracking-[0.2em]">Wait Duration
                                (sec)</label>
                            <input type="number" id="v-wait" value="3" oninput="syncFromVisual()" placeholder="3"
                                class="w-full bg-white/[0.05] border border-white/10 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-white/30 transition-all text-white">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[9px] font-bold text-gray-400 uppercase tracking-[0.2em]">CSS
                                Selector</label>
                            <input type="text" id="v-selector" oninput="syncFromVisual()" placeholder=".target-class"
                                class="w-full bg-white/[0.05] border border-white/10 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-white/30 transition-all placeholder:text-gray-500 text-white">
                        </div>
                    </div>

                    <!-- Agent Fields -->
                    <div id="v-agent-fields" class="hidden space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="text-[9px] font-bold text-gray-400 uppercase tracking-[0.2em]">Action
                                Sequence</label>
                            <span
                                class="text-[7px] font-bold text-blue-400/40 uppercase tracking-widest border border-blue-400/10 px-1.5 py-0.5 rounded">Experimental
                                Builder</span>
                        </div>
                        <div id="action-list" class="space-y-4">
                            <!-- Injected Actions -->
                        </div>
                        <button onclick="addAction()"
                            class="w-full py-4 border border-dashed border-white/20 rounded-2xl text-[10px] font-bold uppercase tracking-widest text-gray-400 hover:border-white/40 hover:text-white transition-all bg-white/[0.02] hover:bg-white/[0.04]">+
                            Add Action</button>
                    </div>
                </div>

                <!-- JSON Area -->
                <div id="json-input-container" class="hidden">
                    <textarea id="json-input" oninput="syncFromJSON()"
                        class="w-full h-96 bg-black/40 border border-white/10 rounded-2xl p-6 font-mono text-[11px] text-blue-300 focus:outline-none focus:border-white/30 custom-scrollbar resize-none"></textarea>
                </div>

                <!-- Stealth Matrix -->
                <div id="stealth-options" class="pt-8 border-t border-white/10 space-y-6">
                    <div class="flex items-center justify-between">
                        <span class="text-[9px] font-bold text-white uppercase tracking-[0.2em]">Advanced Options</span>
                        <span
                            class="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-blue-500/10 text-[8px] font-bold text-blue-400 border border-blue-500/20">
                            <span class="w-1 h-1 bg-blue-400 rounded-full animate-pulse"></span> SESSION_ACTIVE
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <label
                            class="flex items-center gap-3 p-3.5 rounded-2xl bg-white/[0.04] border border-white/10 hover:bg-white/[0.07] transition-all cursor-pointer group">
                            <input type="checkbox" id="rotate-ua-toggle" onchange="syncFromVisual()"
                                class="w-4 h-4 rounded border-white/20 bg-transparent text-white focus:ring-0 focus:ring-offset-0">
                            <span
                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest group-hover:text-white transition-colors">Rotate
                                UA</span>
                        </label>
                        <label
                            class="behavioral-option flex items-center gap-3 p-3.5 rounded-2xl bg-white/[0.04] border border-white/10 hover:bg-white/[0.07] transition-all cursor-pointer group">
                            <input type="checkbox" id="human-typing-toggle" onchange="syncFromVisual()"
                                class="w-4 h-4 rounded border-white/20 bg-transparent text-white focus:ring-0 focus:ring-offset-0">
                            <span
                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest group-hover:text-white transition-colors">Natural
                                Typing</span>
                        </label>
                        <label
                            class="behavioral-option flex items-center gap-3 p-3.5 rounded-2xl bg-white/[0.04] border border-white/10 hover:bg-white/[0.07] transition-all cursor-pointer group">
                            <input type="checkbox" id="stealth-typos" onchange="syncFromVisual()"
                                class="w-4 h-4 rounded border-white/20 bg-transparent text-white focus:ring-0 focus:ring-offset-0">
                            <span
                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest group-hover:text-white transition-colors">Allow
                                Typos</span>
                        </label>
                        <label
                            class="behavioral-option flex items-center gap-3 p-3.5 rounded-2xl bg-white/[0.04] border border-white/10 hover:bg-white/[0.07] transition-all cursor-pointer group">
                            <input type="checkbox" id="stealth-idle" onchange="syncFromVisual()"
                                class="w-4 h-4 rounded border-white/20 bg-transparent text-white focus:ring-0 focus:ring-offset-0">
                            <span
                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest group-hover:text-white transition-colors">Restless
                                Idle</span>
                        </label>
                        <label
                            class="behavioral-option flex items-center gap-3 p-3.5 rounded-2xl bg-white/[0.04] border border-white/10 hover:bg-white/[0.07] transition-all cursor-pointer group">
                            <input type="checkbox" id="stealth-overscroll" onchange="syncFromVisual()"
                                class="w-4 h-4 rounded border-white/20 bg-transparent text-white focus:ring-0 focus:ring-offset-0">
                            <span
                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest group-hover:text-white transition-colors">Overscroll</span>
                        </label>
                        <label
                            class="behavioral-option flex items-center gap-3 p-3.5 rounded-2xl bg-white/[0.04] border border-white/10 hover:bg-white/[0.07] transition-all cursor-pointer group">
                            <input type="checkbox" id="stealth-deadclicks" onchange="syncFromVisual()"
                                class="w-4 h-4 rounded border-white/20 bg-transparent text-white focus:ring-0 focus:ring-offset-0">
                            <span
                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest group-hover:text-white transition-colors">Dead
                                Clicks</span>
                        </label>
                        <label
                            class="behavioral-option flex items-center gap-3 p-3.5 rounded-2xl bg-white/[0.04] border border-white/10 hover:bg-white/[0.07] transition-all cursor-pointer group">
                            <input type="checkbox" id="stealth-fatigue" onchange="syncFromVisual()"
                                class="w-4 h-4 rounded border-white/20 bg-transparent text-white focus:ring-0 focus:ring-offset-0">
                            <span
                                class="text-[10px] font-bold text-gray-400 uppercase tracking-widest group-hover:text-white transition-colors">Human
                                Fatigue</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Footer Action -->
            <div class="p-8 border-t border-white/10 bg-black/40 backdrop-blur-xl">
                <button id="run-btn" onclick="runTask()"
                    class="shine-effect w-full bg-white text-black py-5 rounded-2xl font-bold text-[11px] tracking-[0.3em] flex items-center justify-center gap-4 hover:scale-[1.01] active:scale-[0.98] transition-all uppercase shadow-2xl shadow-white/10">
                    <div id="loader"
                        class="hidden w-4 h-4 border-2 border-black/20 border-t-black rounded-full animate-spin"></div>
                    <span id="btn-text">Execute Task</span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto custom-scrollbar bg-[#020202] p-12 lg:p-20 relative">
            <!-- Grid decorative background -->
            <div class="absolute inset-0 opacity-[0.03] pointer-events-none"
                style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 40px 40px;"></div>

            <!-- Empty State -->
            <div id="welcome-msg"
                class="h-full flex flex-col items-center justify-center text-center space-y-8 relative z-10">
                <div
                    class="w-24 h-24 border border-white/5 rounded-[40px] flex items-center justify-center relative overflow-hidden group">
                    <div class="absolute inset-0 bg-white/5 group-hover:bg-white/10 transition-colors"></div>
                    <svg class="w-10 h-10 text-white/20" xmlns="http://www.w3.org/2000/svg" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                            d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z">
                        </path>
                    </svg>
                </div>
                <div class="space-y-3">
                    <h2 class="text-3xl font-bold text-white tracking-tighter">WAITING_FOR_INPUT</h2>
                    <p class="text-gray-500 max-w-sm mx-auto text-[13px] leading-relaxed">Configure your parameters
                        above and click execute to begin.</p>
                </div>
            </div>

            <!-- Execution Results Area -->
            <div id="results-area" class="hidden space-y-12 max-w-7xl mx-auto relative z-10">
                <!-- Mission Status Header -->
                <div class="flex items-end justify-between border-b border-white/5 pb-10">
                    <div class="space-y-4">
                        <p class="text-[9px] font-bold text-gray-500 uppercase tracking-[0.4em]">Execution Details
                        </p>
                        <h2 id="res-url"
                            class="text-2xl font-bold font-mono text-white truncate break-all max-w-3xl tracking-tight">
                            https://...</h2>
                    </div>
                    <div class="flex gap-4">
                        <div
                            class="px-4 py-2 rounded-2xl bg-blue-500/5 border border-blue-500/10 flex items-center gap-3">
                            <span class="w-1.5 h-1.5 rounded-full bg-blue-400 animate-pulse"></span>
                            <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Job
                                Complete</span>
                        </div>
                        <div class="px-4 py-2 rounded-2xl bg-white/5 border border-white/10 flex items-center gap-3">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest"
                                id="res-timestamp">00:00:00</span>
                        </div>
                    </div>
                </div>

                <!-- Metrics Grid -->
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-10">
                    <!-- Screenshot -->
                    <div id="screenshot-card"
                        class="glass-card rounded-[48px] overflow-hidden flex flex-col group min-h-[500px]">
                        <div class="p-8 border-b border-white/[0.05] flex items-center justify-between">
                            <span class="text-[9px] font-bold text-gray-500 uppercase tracking-[0.2em]">Last
                                Screenshot</span>
                            <span class="text-[9px] font-mono text-white/20">FEED_01</span>
                        </div>
                        <div class="relative bg-black flex-1 flex items-center justify-center overflow-hidden">
                            <!-- Empty State Loader -->
                            <div id="screenshot-placeholder"
                                class="absolute inset-0 flex flex-col items-center justify-center space-y-6 text-gray-800 bg-[#020202]">
                                <div
                                    class="w-12 h-12 border-2 border-white/5 rounded-full border-t-white/40 animate-spin">
                                </div>
                                <span class="text-[9px] font-bold tracking-[0.3em] uppercase opacity-40">Loading
                                    Screenshot...</span>
                            </div>
                            <!-- Actual Image -->
                            <img id="res-screenshot" src=""
                                class="absolute inset-0 w-full h-full object-contain opacity-0 transition-opacity duration-1000"
                                onload="this.classList.remove('opacity-0'); document.getElementById('screenshot-placeholder').classList.add('hidden')">

                            <!-- Hover Overlay -->
                            <div
                                class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center backdrop-blur-md cursor-pointer group/overlay">
                                <span
                                    class="px-8 py-3 bg-white text-black rounded-full text-[10px] font-bold tracking-[0.2em] transform translate-y-4 group-hover/overlay:translate-y-0 transition-transform uppercase">Analyze
                                    Frame</span>
                            </div>
                        </div>
                    </div>

                    <!-- Logs -->
                    <div id="logs-card" class="glass-card rounded-[48px] p-10 flex flex-col">
                        <div class="flex items-center justify-between mb-10">
                            <span class="text-[9px] font-bold text-gray-500 uppercase tracking-[0.2em]">Execution
                                Logs</span>
                            <span id="log-count"
                                class="text-[9px] font-mono text-blue-400/60 bg-blue-400/5 px-3 py-1 rounded-full border border-blue-400/10 uppercase tracking-widest">0
                                Entries</span>
                        </div>
                        <div id="res-logs"
                            class="flex-1 font-mono text-[11px] leading-relaxed text-gray-400 space-y-3 overflow-y-auto custom-scrollbar pr-6">
                            <!-- Logs injected here -->
                        </div>
                    </div>
                </div>

                <!-- HTML Result -->
                <div class="glass-card rounded-[48px] p-10">
                    <div class="flex items-center justify-between mb-8">
                        <span class="text-[9px] font-bold text-gray-500 uppercase tracking-[0.2em]">Extracted
                            Content</span>
                        <button onclick="copyToClipboard('res-html')"
                            class="text-[9px] font-bold text-white/30 hover:text-white transition-all flex items-center gap-3 uppercase tracking-[0.2em] group">
                            <svg class="w-4 h-4 group-hover:scale-110 transition-transform"
                                xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                                </path>
                            </svg>
                            Export Segment
                        </button>
                    </div>
                    <div class="bg-black/20 rounded-[32px] p-8 border border-white/5">
                        <pre id="res-html"
                            class="font-mono text-[11px] leading-loose text-gray-600 overflow-x-auto custom-scrollbar whitespace-pre-wrap max-h-[700px]"></pre>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentMode = 'scrape';
        let currentView = 'visual';

        const defaultConfigs = {
            scrape: {
                url: "https://www.ebay.com/sch/i.html?_nkw=drone",
                wait: 3,
                rotateUserAgents: false
            },
            agent: {
                url: "https://www.google.com",
                rotateUserAgents: false,
                humanTyping: false,
                stealth: {
                    allowTypos: false,
                    idleMovements: false,
                    overscroll: false,
                    deadClicks: false,
                    fatigue: false
                },
                actions: [
                    { type: "fill", selector: "[name='q']", value: "Playwright automation" },
                    { type: "press", key: "Enter" }
                ]
            },
            headful: {
                url: "https://instagram.com"
            }
        };

        let config = JSON.parse(JSON.stringify(defaultConfigs[currentMode]));

        function setView(view) {
            currentView = view;

            const btnVisual = document.getElementById('btn-visual');
            const btnJson = document.getElementById('btn-json');
            const visualEditor = document.getElementById('visual-editor');
            const jsonInputContainer = document.getElementById('json-input-container');

            if (view === 'visual') {
                btnVisual.className = "pb-2 text-[10px] font-bold tracking-[0.2em] border-b-2 border-white text-white uppercase transition-all";
                btnJson.className = "pb-2 text-[10px] font-bold tracking-[0.2em] border-b-2 border-transparent text-gray-500 hover:text-gray-300 uppercase transition-all";
                visualEditor.classList.remove('hidden');
                jsonInputContainer.classList.add('hidden');
                syncToVisual();
            } else {
                btnJson.className = "pb-2 text-[10px] font-bold tracking-[0.2em] border-b-2 border-white text-white uppercase transition-all";
                btnVisual.className = "pb-2 text-[10px] font-bold tracking-[0.2em] border-b-2 border-transparent text-gray-500 hover:text-gray-300 uppercase transition-all";
                jsonInputContainer.classList.remove('hidden');
                visualEditor.classList.add('hidden');
                syncToJSON();
            }
        }

        function setMode(mode, el) {
            currentMode = mode;

            document.querySelectorAll('.mode-tab').forEach(b => {
                b.className = "mode-tab flex-1 py-2 text-[10px] font-bold tracking-widest uppercase rounded-lg transition-all duration-200 text-gray-400 hover:text-white";
            });
            el.className = "mode-tab flex-1 py-2 text-[10px] font-bold tracking-widest uppercase rounded-lg transition-all duration-200 bg-white text-black shadow-lg";

            config = JSON.parse(JSON.stringify(defaultConfigs[mode]));

            document.getElementById('v-scraper-fields').classList.toggle('hidden', mode !== 'scrape');
            document.getElementById('v-agent-fields').classList.toggle('hidden', mode !== 'agent');
            // Selective Options Visibility
            const rotateUa = document.getElementById('rotate-ua-toggle').closest('label');
            const behavioral = document.querySelectorAll('.behavioral-option');

            if (mode === 'agent') {
                rotateUa.style.opacity = '1';
                rotateUa.style.pointerEvents = 'auto';
                behavioral.forEach(el => { el.style.opacity = '1'; el.style.pointerEvents = 'auto'; });
            } else if (mode === 'scrape') {
                rotateUa.style.opacity = '1';
                rotateUa.style.pointerEvents = 'auto';
                behavioral.forEach(el => { el.style.opacity = '0.2'; el.style.pointerEvents = 'none'; });
            } else {
                rotateUa.style.opacity = '0.2';
                rotateUa.style.pointerEvents = 'none';
                behavioral.forEach(el => { el.style.opacity = '0.2'; el.style.pointerEvents = 'none'; });
            }

            document.getElementById('welcome-msg').classList.remove('hidden');
            document.getElementById('results-area').classList.add('hidden');

            syncToVisual();
            syncToJSON();
        }

        function syncToVisual() {
            document.getElementById('v-url').value = config.url || '';
            if (currentMode === 'scrape') {
                document.getElementById('v-wait').value = config.wait || 2;
                document.getElementById('v-selector').value = config.selector || '';
            }
            if (currentMode === 'agent') renderActions();

            document.getElementById('rotate-ua-toggle').checked = config.rotateUserAgents || false;
            document.getElementById('human-typing-toggle').checked = config.humanTyping || false;
            const stealth = config.stealth || {};
            document.getElementById('stealth-typos').checked = stealth.allowTypos || false;
            document.getElementById('stealth-idle').checked = stealth.idleMovements || false;
            document.getElementById('stealth-overscroll').checked = stealth.overscroll || false;
            document.getElementById('stealth-deadclicks').checked = stealth.deadClicks || false;
            document.getElementById('stealth-fatigue').checked = stealth.fatigue || false;
        }

        function syncFromVisual() {
            config.url = document.getElementById('v-url').value;
            if (currentMode === 'scrape') {
                config.wait = parseFloat(document.getElementById('v-wait').value) || 0;
                config.selector = document.getElementById('v-selector').value;
            }
            if (currentMode === 'agent') {
                const cards = document.querySelectorAll('.action-card-item');
                config.actions = Array.from(cards).map(card => {
                    const type = card.querySelector('.a-type').value;
                    const res = { type };
                    if (card.querySelector('.a-selector')) res.selector = card.querySelector('.a-selector').value;

                    const valInput = card.querySelector('.a-value');
                    if (valInput) {
                        const val = valInput.value;
                        res.value = (type === 'wait') ? (parseFloat(val) || 0) : val;
                    }

                    if (card.querySelector('.a-key')) res.key = card.querySelector('.a-key').value;
                    return res;
                });
            }
            config.rotateUserAgents = document.getElementById('rotate-ua-toggle').checked;
            config.humanTyping = document.getElementById('human-typing-toggle').checked;
            config.stealth = {
                allowTypos: document.getElementById('stealth-typos').checked,
                idleMovements: document.getElementById('stealth-idle').checked,
                overscroll: document.getElementById('stealth-overscroll').checked,
                deadClicks: document.getElementById('stealth-deadclicks').checked,
                fatigue: document.getElementById('stealth-fatigue').checked
            };
            syncToJSON();
        }

        function syncToJSON() {
            document.getElementById('json-input').value = JSON.stringify(config, null, 2);
        }

        function syncFromJSON() {
            try {
                config = JSON.parse(document.getElementById('json-input').value);
                syncToVisual();
            } catch (e) { }
        }

        function addAction() {
            if (!config.actions) config.actions = [];
            config.actions.push({ type: 'click', selector: '' });
            renderActions();
            syncToJSON();
        }

        function removeAction(index) {
            config.actions.splice(index, 1);
            renderActions();
            syncToJSON();
        }

        function renderActions() {
            const list = document.getElementById('action-list');
            list.innerHTML = '';
            (config.actions || []).forEach((act, i) => {
                const card = document.createElement('div');
                card.className = 'action-card-item group relative pl-6 border-l-2 border-white/10 hover:border-white/30 transition-all animate-in fade-in slide-in-from-top-4 duration-300';
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <select class="bg-transparent text-[8px] font-black uppercase tracking-[0.2em] text-white/40 focus:outline-none a-type cursor-pointer hover:text-white transition-colors" onchange="updateActionType(${i}, this.value)">
                            <option value="click" class="bg-bg text-white" ${act.type === 'click' ? 'selected' : ''}>Click</option>
                            <option value="type" class="bg-bg text-white" ${act.type === 'type' ? 'selected' : ''}>Type</option>
                            <option value="navigate" class="bg-bg text-white" ${act.type === 'navigate' ? 'selected' : ''}>Navigate</option>
                            <option value="press" class="bg-bg text-white" ${act.type === 'press' ? 'selected' : ''}>Press Key</option>
                            <option value="wait" class="bg-bg text-white" ${act.type === 'wait' ? 'selected' : ''}>Wait</option>
                            <option value="scroll" class="bg-bg text-white" ${act.type === 'scroll' ? 'selected' : ''}>Scroll</option>
                        </select>
                        <button onclick="removeAction(${i})" class="opacity-0 group-hover:opacity-100 text-[7px] font-bold text-red-500/40 hover:text-red-400 transition-all uppercase tracking-widest">Remove</button>
                    </div>
                    <div class="space-y-3">
                        ${renderActionFields(act)}
                    </div>`;
                list.appendChild(card);
            });
        }

        function renderActionFields(act) {
            let html = '';
            const inputClass = "w-full bg-white/[0.03] border border-white/5 rounded-xl px-4 py-2.5 text-[11px] focus:outline-none focus:border-white/20 transition-all a-selector placeholder:text-gray-600 text-white";

            if (['click', 'type', 'fill', 'select'].includes(act.type)) {
                html += `<input type="text" class="${inputClass} a-selector" placeholder="Component Selector" value="${act.selector || ''}" oninput="syncFromVisual()">`;
            }
            if (['type', 'fill', 'navigate', 'goto', 'wait', 'select'].includes(act.type)) {
                const p = act.type === 'wait' ? '3 (seconds)' : 'Parameter / Data';
                html += `<input type="text" class="${inputClass.replace('a-selector', 'a-value')} mt-2" placeholder="${p}" value="${act.value || ''}" oninput="syncFromVisual()">`;
            }
            if (act.type === 'press') {
                const keys = [
                    'Enter', 'Tab', 'Escape', 'Backspace', 'Delete', 'Space',
                    'ArrowDown', 'ArrowUp', 'ArrowRight', 'ArrowLeft',
                    ...'abcdefghijklmnopqrstuvwxyz'.split(''),
                    ...'0123456789'.split(''),
                    ...'!@#$%^&*()_+{}|:"<>?~-=[]\\;\',./'.split('')
                ];

                html += `<select class="${inputClass.replace('a-selector', 'a-key')} mt-2 cursor-pointer" onchange="syncFromVisual()">`;
                keys.forEach(k => {
                    html += `<option class="bg-bg text-white" value="${k}" ${act.key === k ? 'selected' : ''}>${k === ' ' ? 'Space' : k}</option>`;
                });
                html += `</select>`;
            }
            return html;
        }

        function updateActionType(index, newType) {
            config.actions[index].type = newType;
            renderActions();
            syncToJSON();
        }

        function copyToClipboard(id) {
            const el = document.getElementById(id);
            const text = el.innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('Buffer Segment Synchronized.');
            });
        }

        async function runTask() {
            const btn = document.getElementById('run-btn');
            const loader = document.getElementById('loader');
            const btnText = document.getElementById('btn-text');
            const welcome = document.getElementById('welcome-msg');
            const results = document.getElementById('results-area');

            if (currentView === 'visual') syncFromVisual();
            else syncFromJSON();

            btn.disabled = true;
            loader.classList.remove('hidden');
            btnText.innerText = 'PROCESSING...';
            welcome.classList.add('hidden');
            results.classList.add('hidden');

            // Reset screenshot UI state
            document.getElementById('res-screenshot').src = "";
            document.getElementById('res-screenshot').classList.add('opacity-0');
            document.getElementById('screenshot-placeholder').classList.remove('hidden');

            try {
                const response = await fetch(`/${currentMode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                const data = await response.json();

                document.getElementById('res-url').innerText = data.final_url || data.url || config.url;
                document.getElementById('res-html').innerText = data.html || "SEGMENT_EMPTY";
                document.getElementById('res-timestamp').innerText = new Date().toLocaleTimeString();

                if (data.screenshot_url) {
                    document.getElementById('res-screenshot').src = data.screenshot_url + '?t=' + Date.now();
                    document.getElementById('screenshot-card').classList.remove('hidden');
                } else {
                    document.getElementById('screenshot-card').classList.add('hidden');
                }

                const logArea = document.getElementById('res-logs');
                logArea.innerHTML = '';
                if (data.logs && data.logs.length > 0) {
                    data.logs.forEach(log => {
                        const div = document.createElement('div');
                        div.className = "flex gap-4 items-start";
                        div.innerHTML = `<span class="text-white/10 shrink-0 font-bold"></span> <span class="tracking-tight">${log}</span>`;
                        logArea.appendChild(div);
                    });
                    document.getElementById('log-count').innerText = `${data.logs.length} LOG SEGMENTS`;
                    document.getElementById('logs-card').classList.remove('hidden');
                } else {
                    document.getElementById('logs-card').classList.add('hidden');
                }

                results.classList.remove('hidden');
            } catch (err) {
                alert("Execution Error: " + err.message);
            } finally {
                btn.disabled = false;
                loader.classList.add('hidden');
                btnText.innerText = 'EXECUTE TASK';
            }
        }
    </script>
</body>

</html>